//=================== rAthena Script ============================
//    ___     _____   _    _  __   __  ______   ______
//   |  _ \  |  _  | | |  | | \ \ / / |  __  | |  __  |
//   | |_)/  | |_) / | |  | |  \ V /  | |__| | | |  | |
//   |  _ \  |    /  | |  | |   > <   |  __  | | |  | |
//   | |_) . | /\ \  | |__| |  / . \  | |  | | | |__| |
//   |____/  |_| \_\ |______| /_/ \_\ |_|  |_| |______|       
//                                                  
//===============================================================
//              SISTEMA DE RELATÓRIOS DE BUGS
//===============================================================
// Versão: 1.1 - Sistema Corrigido
// Autor: Claude AI - Revisado
//===============================================================

prontera,167,162,5	script	Ragnarok Online	835,{
	
OnInit:

setunitdata getnpcid(0), UNPC_GROUP_ID, 58;	
setunittitle getnpcid(0), "[Suporte YoYo]";
end;
	
}

prontera,167,161,5	script	#BurReport1	111,{
OnInit:
	// Chat em cima do npc
	while(1) {
		showscript "[ Suporte YoYoRO ]", getnpcid(0);
		sleep 100;
	}
	end;
}

prontera,170,163,3	script	Reportar Bug	831,{

set @np$,"^7401DF[Suporte YoYoRO]^000000";

// =============================
// PAINEL ADMINISTRATIVO (GM)
// =============================
if (getgmlevel() == 99) {
    mes @np$;
    mes "^FF0000=== PAINEL ADMINISTRATIVO ===^000000";
    mes "Total de relatórios: ^339966"+getarraysize($bug_reports$)+"^000000";
    mes "Relatórios pendentes: ^FF0000"+$bug_pending_count+"^000000";
    mes "Relatórios aprovados: ^339966"+$bug_approved_count+"^000000";
    next;
    
    if (getarraysize($bug_reports$) == 0) {
        mes @np$;
        mes "Não há relatórios de bugs no momento.";
        close;
    }
    
    switch(select("^339966[»]^000000 Ver Relatórios Pendentes", 
                  "^339966[»]^000000 Ver Todos os Relatórios", 
                  "^339966[»]^000000 Lixeira (Rejeitados)",
                  "^339966[»]^000000 Limpar Relatórios Aprovados",
                  "^ff0000[»] Sair^000000")) {
        
        case 1: // Ver Relatórios Pendentes
            if($bug_pending_count == 0) {
                mes @np$;
                mes "^FF6600Não há relatórios pendentes no momento.^000000";
                close;
            }
            callsub(ViewReports, 1); // 1 = apenas pendentes
            break;
            
        case 2: // Ver Todos os Relatórios
            if(getarraysize($bug_reports$) == 0) {
                mes @np$;
                mes "^FF6600Não há relatórios no sistema.^000000";
                close;
            }
            callsub(ViewReports, 0); // 0 = todos
            break;
            
        case 3: // Ver Lixeira (Rejeitados)
            callsub(ViewRejectedReports);
            break;
            
        case 4: // Limpar Relatórios Aprovados
            mes @np$;
            mes "Deseja limpar todos os relatórios já aprovados?";
            mes "^FF0000Esta ação não pode ser desfeita!^000000";
            next;
            if(select("^FF0000[»] Cancelar^000000", "^339966[»]^000000 Confirmar Limpeza") == 2) {
                callsub(CleanApprovedReports);
            }
            break;
            
        case 5: // Sair
            close;
    }
    end;
}

// =============================
// INTERFACE DO JOGADOR
// =============================
// Buscar pontos do jogador
query_sql "SELECT `yoyoro_points` FROM `char` WHERE `account_id` = "+getcharid(3), @player_points;

mes @np$;
mes "Saudações, ^ffa500"+strcharinfo(0)+"^000000!";
mes "Aqui você pode reportar bugs encontrados no servidor.";
mes "";
mes "^339966Seus Pontos YoYoRO:^000000 ^FF0000"+@player_points+"^000000 pontos";
mes "^ff0000Dica:^000000 Relatórios aprovados rendem +1 Ponto YoYoRO!";
next;

switch(select("^339966[»]^000000 Reportar Bug", 
              "^339966[»]^000000 Meus Relatórios", 
              "^339966[»]^000000 Relatórios Rejeitados",
              "^339966[»]^000000 Meus Pontos YoYoRO",
              "^339966[»]^000000 Como Reportar",
              "^FF0000[»] Sair^000000")) {
    
    case 1: // Reportar Bug
        callsub(ReportBug);
        break;
        
    case 2: // Ver Meus Relatórios
        callsub(MyReports);
        break;
        
    case 3: // Ver Relatórios Rejeitados
        callsub(RejectedReports);
        break;
        
    case 4: // Ver Pontos YoYoRO
        callsub(MyYoYoROPoints);
        break;
        
    case 5: // Instruções
        callsub(HowToReport);
        break;
        
    case 6: // Sair
        close;
}
end;

// =============================
// SUB-ROTINAS
// =============================

// Ver lixeira de relatórios rejeitados (GM)
ViewRejectedReports:
    mes @np$;
    mes "^FF0000=== LIXEIRA - RELATÓRIOS REJEITADOS ===^000000";
    
    if(getarraysize($bug_rejected_reports$) == 0) {
        mes "";
        mes "A lixeira está vazia.";
        mes "Nenhum relatório foi rejeitado ainda.";
        close;
    }
    
    mes "Total na lixeira: ^FF0000"+getarraysize($bug_rejected_reports$)+"^000000 relatórios";
    next;
    
    switch(select("^339966[»]^000000 Ver Relatórios Rejeitados", 
                  "^339966[»]^000000 Esvaziar Lixeira",
                  "^ff0000[»] Voltar^000000")) {
        
        case 1: // Ver rejeitados
            mes @np$;
            mes "^FF0000=== RELATÓRIOS REJEITADOS ===^000000";
            
            for(set @i, 0; @i < getarraysize($bug_rejected_reports$); set @i, @i + 1) {
                explode(@report_data$, $bug_rejected_reports$[@i], "|");
                
                mes "^FF0000--- Relatório #"+@report_data$[0]+" (REJEITADO) ---^000000";
                mes "Player: ^339966"+@report_data$[1]+"^000000";
                mes "Data Original: ^808080"+@report_data$[6]+"^000000";
                mes "Data Rejeição: ^808080"+@report_data$[7]+"^000000";
                mes "Local: ^339966"+@report_data$[4]+"^000000";
                mes "Descrição: "+@report_data$[3];
                mes "^FF6600Motivo: "+@report_data$[8]+"^000000";
                mes "";
                
                if((@i + 1) % 2 == 0 && @i < getarraysize($bug_rejected_reports$) - 1) {
                    next;
                    mes @np$;
                    mes "^FF0000=== RELATÓRIOS REJEITADOS (cont.) ===^000000";
                }
            }
            break;
            
        case 2: // Esvaziar lixeira
            mes @np$;
            mes "^FF0000ATENÇÃO!^000000 Deseja esvaziar completamente a lixeira?";
            mes "Todos os relatórios rejeitados serão removidos permanentemente!";
            next;
            
            if(select("^339966[»]^000000 Cancelar", "^FF0000[»] CONFIRMAR EXCLUSÃO^000000") == 2) {
                // Limpar array de rejeitados
                for(set @i, 0; @i < getarraysize($bug_rejected_reports$); set @i, @i + 1) {
                    set $bug_rejected_reports$[@i], "";
                }
                
                mes @np$;
                mes "^339966Lixeira esvaziada com sucesso!^000000";
                mes "Todos os relatórios rejeitados foram removidos.";
            } else {
                mes @np$;
                mes "Operação cancelada.";
            }
            break;
            
        case 3: // Voltar
            break;
    }
    return;

// Ver relatórios rejeitados do jogador
RejectedReports:
    mes @np$;
    mes "^FF0000=== RELATÓRIOS REJEITADOS ===^000000";
    
    set @rejected_count, 0;
    
    for(set @i, 0; @i < getarraysize($bug_rejected_reports$); set @i, @i + 1) {
        explode(@report_data$, $bug_rejected_reports$[@i], "|");
        
        if(atoi(@report_data$[2]) == getcharid(3)) { // Meu Account ID
            set @rejected_count, @rejected_count + 1;
        }
    }
    
    mes "Total de relatórios rejeitados: ^FF0000"+@rejected_count+"^000000";
    
    if(@rejected_count == 0) {
        mes "";
        mes "^339966Parabéns!^000000 Você não tem relatórios rejeitados.";
        close;
    }
    
    next;
    mes @np$;
    mes "^FF0000=== DETALHES DOS REJEITADOS ===^000000";
    
    for(set @i, 0; @i < getarraysize($bug_rejected_reports$); set @i, @i + 1) {
        explode(@report_data$, $bug_rejected_reports$[@i], "|");
        
        if(atoi(@report_data$[2]) == getcharid(3)) {
            mes "^FF0000--- Relatório #"+@report_data$[0]+" (REJEITADO) ---^000000";
            mes "Data Original: ^808080"+@report_data$[6]+"^000000";
            mes "Data Rejeição: ^808080"+@report_data$[7]+"^000000";
            mes "Local: ^339966"+@report_data$[4]+"^000000";
            mes "Descrição: "+@report_data$[3];
            mes "^FF6600Motivo: "+@report_data$[8]+"^000000";
            mes "";
        }
    }
    close;

// Ver pontos YoYoRO do jogador
MyYoYoROPoints:
    query_sql "SELECT `yoyoro_points` FROM `char` WHERE `account_id` = "+getcharid(3), @player_points;
    
    mes @np$;
    mes "^9966FF=== SEUS PONTOS YoYoRO ===^000000";
    mes "";
    mes "^FF0000Pontos Disponíveis: "+@player_points+"^000000";
    mes "";
    mes "^339966Como ganhar pontos:^000000";
    mes "• Por meio de reporte de bugs aprovados pelo ADM: ^FF0000+1 ponto.^000000";
    mes "• Participando de eventos especiais da STAFF.";
    mes "• Contribuindo com a comunidade.";
    next;
    
    mes @np$;
    mes "^339966Como usar os pontos:^000000";
    mes "• Na loja de itens exclusivos.";
    mes "• Em benefícios especiais dentro do jogo.";
    mes "• Em recompensas personalizadas disponibilizadas pela STAFF.";
    mes "";
    mes "^ff0000Procure por NPCs de troca dentro do servidor!^000000";
    close;

// Reportar um novo bug
ReportBug:
    mes @np$;
    mes "Por favor, descreva o bug encontrado.";
    mes "Seja o mais detalhado possível!";
    mes "";
    mes "^FF0000Máximo: 200 caracteres^000000";
    next;
    
    input @bug_description$;
    
    if(getstrlen(@bug_description$) < 10) {
        mes @np$;
        mes "^FF0000Erro:^000000 Descrição muito curta!";
        mes "Por favor, seja mais detalhado (mínimo 10 caracteres).";
        close;
    }
    
    mes @np$;
    mes "Onde ocorreu o bug?";
    mes "Digite o nome do mapa ou local:";
    next;
    
    input @bug_location$;
    
    if(@bug_location$ == "") {
        set @bug_location$, "Não informado";
    }
    
    mes @np$;
    mes "^FF0000=== CONFIRMAÇÃO ===^000000";
    mes "^339966Descrição:^000000 "+@bug_description$;
    mes "^339966Local:^000000 "+@bug_location$;
    mes "";
    mes "Confirma o envio do relatório?";
    next;
    
    if(select("^FF0000[»] Cancelar^000000", "^339966[»]^000000 Confirmar envio") == 1) {
        mes @np$;
        mes "Relatório cancelado.";
        close;
    }
    
    // Salvar o relatório
    set @report_id, $bug_next_id;
    set $bug_next_id, $bug_next_id + 1;
    
    set @array_pos, getarraysize($bug_reports$);
    
    // Formato: ID|Player|AccountID|Description|Location|Status|Date
    set $bug_reports$[@array_pos], @report_id+"|"+strcharinfo(0)+"|"+getcharid(3)+"|"+@bug_description$+"|"+@bug_location$+"|PENDENTE|"+gettimestr("%d/%m/%Y %H:%M",21);
    
    set $bug_pending_count, $bug_pending_count + 1;
    
    mes @np$;
    mes "^339966Relatório enviado com sucesso!^000000";
    mes "ID do relatório: ^FF0000#"+@report_id+"^000000";
    mes "";
    mes "Você será recompensado com ^FF00001 Ponto YoYoRO^000000";
    mes "após a aprovação do relatório pelos administradores.";
    
    // Notificar GMs online
    announce "[Bug Report] Novo relatório de "+strcharinfo(0)+" (ID: #"+@report_id+")", bc_all, 0xFF0000;
    close;

// Ver meus relatórios
MyReports:
    mes @np$;
    mes "^FF0000=== MEUS RELATÓRIOS ===^000000";
    
    set @my_reports, 0;
    set @my_pending, 0;
    set @my_approved, 0;
    
    for(set @i, 0; @i < getarraysize($bug_reports$); set @i, @i + 1) {
        explode(@report_data$, $bug_reports$[@i], "|");
        
        if(atoi(@report_data$[2]) == getcharid(3)) { // Meu Account ID
            set @my_reports, @my_reports + 1;
            if(@report_data$[5] == "PENDENTE") {
                set @my_pending, @my_pending + 1;
            } else if(@report_data$[5] == "APROVADO") {
                set @my_approved, @my_approved + 1;
            }
        }
    }
    
    mes "Total de relatórios: ^339966"+@my_reports+"^000000";
    mes "Pendentes: ^FF0000"+@my_pending+"^000000";
    mes "Aprovados: ^339966"+@my_approved+"^000000";
    
    if(@my_reports == 0) {
        mes "";
        mes "Você ainda não fez nenhum relatório.";
        close;
    }
    
    next;
    mes @np$;
    mes "^FF0000=== DETALHES DOS RELATÓRIOS ===^000000";
    
    for(set @i, 0; @i < getarraysize($bug_reports$); set @i, @i + 1) {
        explode(@report_data$, $bug_reports$[@i], "|");
        
        if(atoi(@report_data$[2]) == getcharid(3)) {
            mes "^0080FF--- Relatório #"+@report_data$[0]+" ---^000000";
            if(@report_data$[5] == "PENDENTE") {
                mes "Status: ^FF0000PENDENTE^000000";
            } else if(@report_data$[5] == "APROVADO") {
                mes "Status: ^339966APROVADO^000000";
            }
            mes "Data: ^808080"+@report_data$[6]+"^000000";
            mes "Local: ^339966"+@report_data$[4]+"^000000";
            mes "Descrição: "+@report_data$[3];
            mes "";
        }
    }
    close;

// Como reportar (instruções)
HowToReport:
    mes @np$;
    mes "^FF0000=== COMO REPORTAR BUGS ===^000000";
    mes "";
    mes "^339966• Seja específico:^000000 Descreva exatamente o que aconteceu.";
    mes "^339966• Local:^000000 Informe onde o bug ocorreu.";
    mes "^339966• Reprodução:^000000 Se possível, explique como reproduzir o bug.";
    next;
    
    mes @np$;
    mes "^FF0000=== EXEMPLOS DE BONS RELATÓRIOS ===^000000";
    mes "";
    mes "^339966Bom:^000000 'No mapa prt_fild01, ao usar a skill Fire Bolt level 10, o dano está 50% menor que deveria.'";
    mes "";
    mes "^FF0000Ruim:^000000 'Skill bugada'";
    next;
    
    mes @np$;
    mes "^FF0000=== RECOMPENSAS ===^000000";
    mes "";
    mes "• Relatórios aprovados resultarão em: ^ff0000+1 Ponto YoYoRO^000000";
    mes "• Os pontos são dados automaticamente após aprovação pela STAFF.";
    mes "• Use os pontos na loja de itens exclusivos.";
    close;

// Ver relatórios (GM)
ViewReports:
    set @show_pending_only, getarg(0);
    set @reports_shown, 0;
    
    for(set @i, 0; @i < getarraysize($bug_reports$); set @i, @i + 1) {
        explode(@report_data$, $bug_reports$[@i], "|");
        
        if(@show_pending_only == 1 && @report_data$[5] != "PENDENTE") {
            continue;
        }
        
        set @reports_shown, @reports_shown + 1;
        
        mes "^0080FF=== Relatório #"+@report_data$[0]+" ===^000000";
        mes "Player: ^339966"+@report_data$[1]+"^000000";
        mes "Status: "+(@report_data$[5] == "PENDENTE" ? "^FF0000PENDENTE^000000" : "^339966APROVADO^000000");
        mes "Data: ^808080"+@report_data$[6]+"^000000";
        mes "Local: ^339966"+@report_data$[4]+"^000000";
        mes "Descrição: "+@report_data$[3];
        
        if(@report_data$[5] == "PENDENTE") {
            mes "^FF0000--- AÇÕES ---^000000";
            
            switch(select("^339966[»]^000000 Aprovar", 
                         "^FF0000[»] Rejeitar^000000", 
                         "^808080[»] Próximo^000000")) {
                case 1: // Aprovar
                    callsub(ApproveReport, atoi(@report_data$[0]), @report_data$[1], atoi(@report_data$[2]));
                    break;
                case 2: // Rejeitar
                    callsub(RejectReport, atoi(@report_data$[0]));
                    break;
                case 3: // Próximo
                    continue;
            }
        }
        
        if(@reports_shown % 3 == 0) {
            next;
        }
    }
    
    if(@reports_shown == 0) {
        mes @np$;
        mes "Nenhum relatório para exibir.";
    }
    return;

// Aprovar relatório
ApproveReport:
    set @report_id, getarg(0);
    set @player_name$, getarg(1);
    set @account_id, getarg(2);
    
    mes @np$;
    mes "Aprovar relatório #"+@report_id+" de "+@player_name$+"?";
    mes "O jogador receberá ^339966+1 Ponto YoYoRO^000000.";
    next;
    
    if(select("^FF0000[»] Cancelar^000000", "^339966[»]^000000 Confirmar Aprovação") == 1) {
        return;
    }
    
    // Atualizar status do relatório
    for(set @i, 0; @i < getarraysize($bug_reports$); set @i, @i + 1) {
        explode(@report_data$, $bug_reports$[@i], "|");
        
        if(atoi(@report_data$[0]) == @report_id) {
            set $bug_reports$[@i], @report_data$[0]+"|"+@report_data$[1]+"|"+@report_data$[2]+"|"+@report_data$[3]+"|"+@report_data$[4]+"|APROVADO|"+@report_data$[6];
            break;
        }
    }
    
    // Dar recompensa
    query_sql "UPDATE `char` SET `yoyoro_points` = `yoyoro_points` + 1 WHERE `account_id` = "+@account_id;
    
    set $bug_pending_count, $bug_pending_count - 1;
    set $bug_approved_count, $bug_approved_count + 1;
    
    mes @np$;
    mes "^339966Relatório aprovado com sucesso!^000000";
    mes ""+@player_name$+" recebeu +1 Ponto YoYoRO.";
    
    // Notificar o jogador se estiver online
    if(isloggedin(@account_id)) {
        message @player_name$, "[Bug Report] Seu relatório #"+@report_id+" foi aprovado! Você recebeu +1 Ponto YoYoRO!";
    }
    return;

// Rejeitar relatório
RejectReport:
    set @report_id, getarg(0);
    
    mes @np$;
    mes "Rejeitar relatório #"+@report_id+"?";
    mes "";
    mes "Digite o motivo da rejeição:";
    next;
    
    input @rejection_reason$;
    
    if(@rejection_reason$ == "") {
        set @rejection_reason$, "Não especificado";
    }
    
    mes @np$;
    mes "^FF0000Confirmar rejeição do relatório #"+@report_id+"?^000000";
    mes "Motivo: "+@rejection_reason$;
    mes "";
    mes "O relatório será movido para a lixeira.";
    next;
    
    if(select("^339966[»]^000000 Cancelar", "^FF0000[»] CONFIRMAR REJEIÇÃO^000000") == 1) {
        return;
    }
    
    // Encontrar o relatório e mover para lixeira
    for(set @i, 0; @i < getarraysize($bug_reports$); set @i, @i + 1) {
        explode(@report_data$, $bug_reports$[@i], "|");
        
        if(atoi(@report_data$[0]) == @report_id) {
            // Mover para array de rejeitados
            set @rejected_pos, getarraysize($bug_rejected_reports$);
            // Formato: ID|Player|AccountID|Description|Location|Status|DateOriginal|DateRejected|Reason
            set $bug_rejected_reports$[@rejected_pos], @report_data$[0]+"|"+@report_data$[1]+"|"+@report_data$[2]+"|"+@report_data$[3]+"|"+@report_data$[4]+"|REJEITADO|"+@report_data$[6]+"|"+gettimestr("%d/%m/%Y %H:%M",21)+"|"+@rejection_reason$;
            
            // Remover relatório do array principal
            for(set @j, @i; @j < getarraysize($bug_reports$) - 1; set @j, @j + 1) {
                set $bug_reports$[@j], $bug_reports$[@j + 1];
            }
            // Limpar o último elemento
            set $bug_reports$[getarraysize($bug_reports$) - 1], "";
            
            // Notificar jogador se estiver online
            if(isloggedin(atoi(@report_data$[2]))) {
                message @report_data$[1], "[Bug Report] Seu relatório #"+@report_id+" foi rejeitado. Motivo: "+@rejection_reason$;
            }
            
            break;
        }
    }
    
    set $bug_pending_count, $bug_pending_count - 1;
    
    mes @np$;
    mes "^FF0000Relatório rejeitado e movido para a lixeira.^000000";
    mes "O jogador foi notificado.";
    return;

// Limpar relatórios aprovados
CleanApprovedReports:
    set @removed, 0;
    
    for(set @i, 0; @i < getarraysize($bug_reports$); set @i, @i + 1) {
        explode(@report_data$, $bug_reports$[@i], "|");
        
        if(@report_data$[5] == "APROVADO") {
            // Remover este relatório
            for(set @j, @i; @j < getarraysize($bug_reports$) - 1; set @j, @j + 1) {
                set $bug_reports$[@j], $bug_reports$[@j + 1];
            }
            set $bug_reports$[getarraysize($bug_reports$) - 1], "";
            set @i, @i - 1; // Ajustar índice
            set @removed, @removed + 1;
        }
    }
    
    set $bug_approved_count, 0;
    
    mes @np$;
    mes "^339966Limpeza concluída!^000000";
    mes "Removidos: ^FF0000"+@removed+"^000000 relatórios aprovados.";
    return;

// =============================
// INICIALIZAÇÃO DO SISTEMA
// =============================
OnInit:
    // Inicializar variáveis do sistema se não existirem
    if($bug_next_id == 0) {
        set $bug_next_id, 1;
    }
    if($bug_pending_count == 0) {
        set $bug_pending_count, 0;
    }
    if($bug_approved_count == 0) {
        set $bug_approved_count, 0;
    }
    
	setunitdata getnpcid(0), UNPC_GROUP_ID, 59;	
	setunittitle getnpcid(0), "[Suporte YoYo]";
	end;

}